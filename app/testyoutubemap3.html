<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
  <style>
    body,html{
      height: 100%;
      width: 100%;
    }
    #map{
      height: 100%;
      width: 48%;
      display: inline-block;
      background-color: #000088;
    }
    #vid{
      height: 100%;
      width: 48%;
      display: inline-block;
      background-color: #008800;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div id="imput"></div>
<div id="player"></div>

<script src="../bower_components/jquery/dist/jquery.min.js"></script>
<script src="../bower_components/openlayers/OpenLayers.js"></script>
<script src="http://maps.google.com/maps/api/js?v=3&amp;sensor=false"></script>
<script src="scripts/MdlMap.js"></script>
<script src="scripts/gmapolLayerline.js"></script>
<script src="scripts/MdlYoutube.js"></script>
<script src="scripts/gmapolMarkerUni.js"></script>
<script>
  /*
  * Binary search in JavaScript.
  * Returns the index of of the element in a sorted array or (-n-1) where n is the insertion point for the new element.
  * Parameters:
  *     ar - A sorted array
  *     el - An element to search for
  *     compare_fn - A comparator function. The function takes two arguments: (a, b) and returns:
  *        a negative number  if a is less than b;
  *        0 if a is equal to b;
  *        a positive number of a is greater than b.
  * The array may contain duplicate elements. If there are more than one equal elements in the array,
  * the returned value can be the index of any one of the equal elements.
  */
  function binarySearch(ar, el, compare_fn) {
    var m = 0;
    var n = ar.length - 1;
    while (m <= n) {
      var k = (n + m) >> 1;
      //console.info(m,n,k);
      var cmp = compare_fn(el, ar[k]);
      if (cmp > 0) {
        m = k + 1;
      } else if(cmp < 0) {
        n = k - 1;
      } else {
        return k;
      }
    }
    return m-1;
  }

  function convert(texto){
    texto = texto.replace(",",".");
    return parseFloat(texto);
  }

  function converLabel(milisegundos){
    var sec = parseInt(milisegundos/1000);

    var min = parseInt(sec/60);
    //console.info(min,sec);
    sec = sec-(min*60);

    return ""+min+"."+sec;

  }

  var MdlYoutubeMap = {
    interval:null,
    dataTrack:null,
    droneMarker:null,
    videodelay:null,
    compare_fn:function(value, item){

      var time = item.tim;

      return value - time;
    },
    load:function(data,vidid,delay){
      var ini = MdlYoutube.isIni();
      if(!ini)//TODO verifica que tenga player
      {
        //TODO cuando tiene player reproduce el video
        MdlYoutube.onPlayerReady= function () {
          MdlYoutubeMap.registraInterval();
          MdlYoutube.playVideo();
        };
        //TODO si no tiene player lo crea
        this.ini(vidid);

        //TODO crea el mapa
        MdlMap.ini();
      }else {//TODO si ya tiene el player
        //TODO borra los datos del mapa

      }
      this.videodelay = (delay)?delay:null;

      //TODO agrega los datos del mapa
      this.drawTrack(data);



    },
    registraInterval: function () {
      if(this.interval)
      {
          clearInterval(this.interval);
      }
      this.interval=setInterval(
              function(){

                var current = MdlYoutube.getCurrentTime();

                var delay = (MdlYoutubeMap.videodelay)?MdlYoutubeMap.videodelay:0;

                MdlYoutubeMap.goToTrackTime((current * 1000)-delay);

              },
              800
      );
    },
    ini:function(divid){

      //console.info(divid);
      //TODO crea el player
      MdlYoutube.ini(divid);

    },
    getReportByTime:function(current){
      //TODO reporta tiempo
      //console.info(current, converLabel(current));
      if (current) {
        var index = binarySearch(this.dataTrack, current, this.compare_fn);
        //console.info(index);
        //console.info("preguntar", current, index);
        current = Math.round(current);
        //$divt.html(current);
        //console.info("preguntar round",current);

        var item = this.dataTrack[index];

        return item;
      }
    },
    drawTrack:function(RECORDS){
      //TODO pinta el track
      var layerrepo = new gmapolLayerLine();

      var latlonIni;
      $(RECORDS).each(function(index,item){
        //console.info(item);
        var lat = convert(item.lat);
        var lon = convert(item.lon);
        var latlon = new OpenLayers.LonLat(lon, lat).transform(wgs84, mercator);


        latlonIni = (!latlonIni)?latlon:null;
        layerrepo.pushPoint(latlon.lat,latlon.lon);
        item.latlon = latlon;
      });
      layerrepo.drawRute();
      layerrepo.toExtend(map);
      this.dataTrack = RECORDS;

      this.droneMarker = new MarkerMove("drone",latlonIni.lat,latlonIni.lon);

    },
    goToTrackTime:function(current){
      //TODO llama el video al determinado tiempo
      var item = this.getReportByTime(current);
      if (item) {
        //console.info("item", item);

        map.panTo(item.latlon);
        this.droneMarker.moveMarkerLatLon(item.latlon);
      }
    },
    goToVideoTime: function (current) {
      MdlYoutube.setTime(current);
    },
    goToVideoTimeByTrack: function (indexTrack) {
      var item = this.dataTrack[indexTrack];
      if (item) {
        console.info("item", item);
        var current = item.tim;

        var delay = (MdlYoutubeMap.videodelay)?MdlYoutubeMap.videodelay:0;

        current = current + delay;

        console.info("time",current,converLabel(current));

        current = current/1000;
        console.info(current);
        this.goToVideoTime(current);

      }
    },
    getTrackLen: function () {
      if (this.dataTrack) {
        var len = this.dataTrack.length;
        return len;
      }

    },
    getVideoLen: function () {
      return MdlYoutube.getVideoLen();
    }
  };

  function createInput(traclen){
    var newInput = document.createElement("input");
    newInput.type="range";
    newInput.name="trackRange";
    newInput.id="trackRange";
    newInput.min=0;
    newInput.max=traclen;
    document.getElementById('imput').appendChild(newInput);
    $(newInput).change(function(event){
      console.info(event);
      var value = event.currentTarget.value;
      console.info(value);
      MdlYoutubeMap.goToVideoTimeByTrack(value);
    });
  }


  var success = function (data) {
    var vidid = data.vid;
    var trackdata = data.RECORDS;
    var delay = data.dly;
    MdlYoutubeMap.load(trackdata,vidid,delay);

    createInput(MdlYoutubeMap.getTrackLen());
  };



  $.ajax({
    //type: "POST",
    dataType: "json",
    //url: "data/combustible_point10.json",
    contentType: "application/json; chartset:utf-8",
    url: "data/reportelogvideodelay.json",
    data: {},
    success: success,
    error: function (error) {
      console.error(error);
    },
    async: true

  });

</script>
</body>
</html>
